### 定义

存储过程是事先经过编译并存储在数据库中的一段 SQL 语句的集合，调用存储过程可以简化应用开发 人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。 存储过程思想上很简单，就是数据库 SQL 语言层面的代码封装与重用。



**特点**

- 封装，复用
- 可以接收参数，也可以返回数据
- 减少网络交互，效率提升


```sql
-- 创建存储过程
CREATE PROCEDURE 存储过程名([参数列表])
BEGIN
	SQL语句
END;

-- 调用存储过程
CALL 存储过程名([参数])

-- 查看存储过程
SELECT * FROM information_schema.ROUTINES WHERE ROUTINE_SCHEMA = '数据库名'
SHOW CREATE PROCEDURE 存储过程名

-- 删除存储过程
DROP PROCEDURE [IF EXISTS] 存储过程名
```

!!!tip
    在命令行工具中创建存储过程时需要使用`delimiter`指定结束符，否则在存储过程中的";"会被认为是结束符而无法成功创建

<br>

### 变量

在MySQL中变量分为三种类型: 系统变量、用户定义变量、局部变量。

#### 系统变量

系统变量是MySQL服务器提供，不是用户定义的，属于服务器层面。分为全局变量（GLOBAL）、会话变量（SESSION）

```sql
-- 查看所有变量
SHOW [SESSION|GLOBAL] VARIABLES;

-- 模糊匹配
SHOW [SESSION|GLOBAL] VARIABLES LIKE '...';

-- 查看具体变量
SELECT @@[SESSION|GLOBAL].变量名;

-- 修改变量值
SET [SESSION|GLOBAL] 变量名 = 值;
```

!!!warning
    - 如果没有指定SESSION/GLOBAL，默认是SESSION，会话变量
    -  mysql服务重新启动之后，所设置的全局参数会失效，要想不失效，需要使用配置文件。



#### 用户自定义变量

用户定义变量是用户根据需要自己定义的变量，用户变量不用提前声明，在用的时候直接用 "@变量名" 使用就可以。其作用域为当前连接。

```sql
-- 变量赋值
SET @var_name = expr [, @var_name = expr] ... ; 
SET @var_name := expr [, @var_name := expr] ... ; 

SELECT 字段名 INTO @var_name FROM 表名;

-- 查看变量
SELECT @var_name[,@var_name,...];
```



#### 局部变量

局部变量是根据需要定义的在局部生效的变量，访问之前，需要DECLARE声明，可用作存储过程内的局部变量和输入参数。

```sql
DECLARE 变量名 变量类型[DEFAULT ...];

SET 变量名 = 值;
SET 变量名 := 值;

SELECT 字段名 INTO 变量名 FROM 表名;
```

<br>

### 流程控制

#### if

```sql
IF condition THEN 
    .....
ELSEIF condition THEN       -- 可选
    .....
ELSE                     -- 可选
    .....
END  IF;
```



#### 参数

示例

```sql
-- 创建带参数的存储过程
create procedure test(in score int, out result varchar(10))
begin
	if score >= 85 then
		set result := '优秀';
	elseif score >= 60 then
		set result := '及格';
	else
		set result := '不及格';
	end if;
end;


-- 调用并接收结果
call test(85, @result);
select @result;
```

!!!note
    `in` 指定为输入参数

    `out` 指定为输出参数

    `inout` 指定既为输入参数也为输出参数



#### case

```sql
-- 语法一
case case_value
	when value1 then statement1
	when value2 then statement2
	...
	else statement
end case;

-- 语法二
case
	when condition then statement1
	when condition then statement2
	...
end case;
```



#### 循环

```sql
-- while循环,condition满足时循环
while condition do
	statement
end while;


-- repeat循环,condition满足时结束循环
repeat
	statement
	until condition
end repeat;


-- loop循环,leave退出循环,iterate直接进入下一层循环
[begin_label:] looop
	statement
end loop [end_label];
-- 示例
label:loop
	if condition then
		leave label;
	end if;
	statement
end loop lael;
```



#### 游标

MySQL游标(Cursor)是一种数据库对象，用于在结果集中逐行处理数据。

```sql
-- 声明游标
declare 游标名称 cursor for 查询语句

-- 打开游标
open 游标名称

-- 获取游标记录
fetch 游标名称 into 变量

-- 关闭游标
close 游标名称


-- 示例
create procedure test(in uage int)
begin
	declare uname varchar(100);
	declare uage int;
	
	-- 声明游标
	declare cursor_user cursor for select name, age from tb_user where age <= uage;
	
	-- 声明游标无数据时处理程序
	declare exit handler for sqlstate '02000' close cursor_user;
	
	create table if not exists user(
    	...
    );
    
	open cursor_suer;
	
	-- 死循环处理数据，由handler处理退出
	while true do
		fetch cursor_user into uname, age;
		insert into user(...) values (uname, age);
	end while;
	
	close cursor_user;
end;
```



#### 条件处理程序

条件处理程序（Handler）可以用来定义在流程控制结构执行过程中遇到问题时相应的处理步骤。

!!!note
    如上小节对游标数据处理完后的条件处理程序

```sql
-- 定义handler
declare handler_action handler for condition_value[,condition_value,...] statement;

-- 参数说明
handler_action
	continue: 继续执行
	exit: 停止执行
condition_value
	sqlstate sqlstate_value: 状态码
	sqlwarning: 以01开头的sqlstate代码简写
	not found: 以02开头的sqlstate代码简写
	sqlexception: 其他sqlstate代码简写
```

<>

### 存储函数

存储函数是有返回值的存储过程，存储函数的参数只能是IN类型的。

```sql
CREATE  FUNCTION 存储函数名称 ([ 参数列表 ])
RETURNS  type  [characteristic ...]
 BEGIN
 	-- SQL语句
	RETURN ...;
 END;
 
-- characteristic说明：
    DETERMINISTIC：相同的输入参数总是产生相同的结果
    NO SQL ：不包含 SQL 语句。
    READS SQL DATA：包含读取数据的语句，但不包含写入数据的语句。
```


